---
import { getSlidesData } from "../actions/cms.actions";
import "swiper/css";
import "swiper/css/pagination";
import "swiper/css/navigation";

// Obtener los slides activos desde Strapi
interface Slide {
    id: number;
    imageUrl: string;
    alternativeText: string | null;
    url?: string | null; // URL opcional para redirección
}

let slides: Slide[] = [];
let error = null;

try {
    const result = await Astro.callAction(getSlidesData, {});
    console.log("Result from getSlidesData:", result);
    
    if (result.error) {
        console.error("Error fetching slides:", result.error);
        error = result.error;
    } else if (result.data && Array.isArray(result.data)) {
        slides = result.data.filter((slide: any) => slide.imageUrl);
        console.log("Slides cargados:", slides.length, slides);
    } else {
        console.error("No data returned from getSlidesData, result:", result);
        console.error("result.data:", result.data);
        error = new Error("No data returned");
    }
} catch (e) {
    console.error("Exception fetching slides:", e);
    error = e;
}
---

{
    error ? (
        <div class="bg-red-100 text-red-700 p-4 rounded-lg mt-8 max-w-2xl mx-auto">
            Error cargando las imágenes del slider
        </div>
    ) : slides.length === 0 ? null : (
        <div class="mt-12 max-w-4xl mx-auto p-4 bg-white rounded-xl shadow-lg">
            <div class="swiper">
                <div class="swiper-wrapper">
                    {slides.map((slide: any, index: number) => (
                        <div class="swiper-slide flex justify-center items-center">
                            {slide.url ? (
                                <a 
                                    href={slide.url}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="block w-full h-full cursor-pointer hover:opacity-95 transition-opacity"
                                >
                                    <img
                                        src={slide.imageUrl}
                                        alt={slide.alternativeText || `Campaña ${index + 1}`}
                                        class="w-full h-auto md:h-[400px] object-cover rounded-lg"
                                    />
                                </a>
                            ) : (
                                <img
                                    src={slide.imageUrl}
                                    alt={slide.alternativeText || `Campaña ${index + 1}`}
                                    class="w-full h-auto md:h-[400px] object-cover rounded-lg"
                                />
                            )}
                        </div>
                    ))}
                </div>
                {slides.length > 1 && (
                    <>
                        <div class="swiper-pagination" />
                        <div class="swiper-button-prev" />
                        <div class="swiper-button-next" />
                    </>
                )}
            </div>
        </div>
    )
}

<script>
    import Swiper from "swiper/bundle";
    
    document.addEventListener("astro:page-load", () => {
        const swiperElement = document.querySelector(".swiper") as any;
        if (swiperElement && !swiperElement.swiper) {
            new Swiper(".swiper", {
                effect: "slide",
                loop: true,
                autoplay: { 
                    delay: 5000, 
                    disableOnInteraction: false,
                    pauseOnMouseEnter: true
                },
                pagination: { 
                    el: ".swiper-pagination", 
                    clickable: true,
                    dynamicBullets: true
                },
                navigation: {
                    nextEl: ".swiper-button-next",
                    prevEl: ".swiper-button-prev",
                },
                slidesPerView: 1,
                spaceBetween: 20,
                speed: 600,
                watchSlidesProgress: true,
                a11y: {
                    enabled: true
                }
            });
        }
    });
</script>

<style>
    /* Mantener solo los estilos de diseño general */
    .swiper {
        width: 100%;
        height: 100%;
    }
    .swiper-slide img {
        display: block;
        margin: 0 auto;
        max-height: 400px;
        object-fit: cover;
        border-radius: 0.75rem;
        transition: transform 0.3s ease;
    }
    
    /* Efecto hover para imágenes con enlace */
    .swiper-slide a:hover img {
        transform: scale(1.02);
    }
    
    /* Mejoras para la paginación */
    .swiper-pagination-bullet {
        width: 12px;
        height: 12px;
        background: rgba(217, 119, 6, 0.5);
    }
    
    .swiper-pagination-bullet-active {
        background: #d97706;
    }
    
    /* Estilo para botones de navegación */
    .swiper-button-next,
    .swiper-button-prev {
        color: #d97706;
    }
    
    .swiper-button-next:after,
    .swiper-button-prev:after {
        font-size: 20px;
    }
</style>
