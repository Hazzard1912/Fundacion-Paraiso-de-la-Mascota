---
import Layout from "../../layouts/Layout.astro";
import { getPet } from "../../actions/cms.actions";

export const prerender = false;

const { documentId } = Astro.params;

const { data, error } = await Astro.callAction(getPet, { documentId });

if (error) {
    console.error(error);
    return Astro.redirect("/404");
}

if (data.data.pet[0].isAdopted) {
    return Astro.redirect("/adopta");
}

const pet = data.data.pet[0] || {};
const siteUrl = Astro.url.origin;
const petUrl = `${siteUrl}/adopta/${pet.documentId}`;
const shareTitle = `Conoce a ${pet.name} y solicita contacto para su adopción | Fundación Paraíso de la Mascota Cali`;
const shareDescription = pet.description ? `${pet.name} está buscando una familia. Comparte este perfil y ayuda a que más personas soliciten contacto para su adopción. ${pet.description.substring(0, 90)}...` : `Comparte el perfil de ${pet.name} y ayúdanos a encontrar personas interesadas en su adopción.`;
const shareImage = pet.imageUrl || `${siteUrl}/images/placeholder-pet.jpg`;

// SEO metadata específica para esta mascota
const seoTitle = `${pet.name} - Perfil de adopción y solicitud de contacto - Paraíso de la Mascota Cali`;
const seoDescription = `${pet.name} está buscando una familia amorosa. Conoce su historia y deja tus datos para que podamos contactarte y evaluar juntos el proceso de adopción.`;
const seoKeywords = `adopción ${pet.species}, ${pet.name}, solicitud contacto adopción, ${pet.size}, adopción Cali, fundación mascotas, ${pet.species} en adopción`;
---

<Layout
    title={seoTitle}
    description={seoDescription}
    keywords={seoKeywords}
    ogTitle={shareTitle}
    ogDescription={shareDescription}
    ogImage={shareImage}
    ogUrl={petUrl}
    canonicalUrl={petUrl}
>
    <main class="bg-amber-50/50 min-h-screen pb-16">
        <!-- Contenido principal -->
        <div class="max-w-6xl mx-auto px-4 py-12">
            <!-- Botón Volver -->
            <a
                href="/adopta"
                class="bg-white/90 backdrop-blur-sm text-amber-900 px-4 py-2 rounded-full shadow-lg hover:bg-amber-100 transition-colors flex items-center gap-2 w-max mb-8"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                >
                    <path
                        fill-rule="evenodd"
                        d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
                        clip-rule="evenodd"></path>
                </svg>
                Volver a mascotas
            </a>

            <!-- Cabecera con nombre de la mascota -->
            <div class="text-center mb-8">
                <h1 class="text-4xl md:text-5xl font-bold text-amber-900">
                    {pet.name}
                </h1>
                <div class="flex flex-wrap gap-3 justify-center mt-4">
                    <span
                        class="px-4 py-2 bg-amber-500/90 backdrop-blur-sm rounded-full text-sm font-medium text-white"
                    >
                        {pet.species}
                    </span>
                    <span
                        class="px-4 py-2 bg-white/90 text-amber-900 rounded-full text-sm font-medium"
                    >
                        {pet.size}
                    </span>
                    <span
                        class="px-4 py-2 bg-white/90 text-amber-900 rounded-full text-sm font-medium"
                    >
                        {pet.ageGroup}
                    </span>
                </div>
            </div>

            <!-- Sección principal con foto e información -->
            <div class="bg-white rounded-3xl shadow-lg overflow-hidden mb-12">
                <div class="md:flex">
                    <!-- Foto de la mascota -->
                    <div class="md:w-2/5 h-[300px] md:h-auto relative">
                        <img
                            src={pet.imageUrl || "/images/placeholder-pet.jpg"}
                            alt={pet.name}
                            class="w-full h-full object-cover"
                        />
                    </div>

                    <!-- Información de la mascota -->
                    <div class="md:w-3/5 p-6 md:p-8">
                        <h2 class="text-2xl font-bold text-amber-900 mb-4">
                            Sobre {pet.name}
                        </h2>
                        <p class="text-gray-600 leading-relaxed mb-6">
                            {pet.description}
                        </p>
                        <div class="grid grid-cols-2 gap-4 mb-8">
                            <div class="bg-amber-50 p-4 rounded-xl">
                                <span class="text-amber-900 font-medium">Edad:</span>
                                <p class="text-gray-600">{pet.ageGroup}</p>
                            </div>
                            <div class="bg-amber-50 p-4 rounded-xl">
                                <span class="text-amber-900 font-medium">Sexo:</span>
                                <p class="text-gray-600">{pet.gender}</p>
                            </div>
                            <div class="bg-amber-50 p-4 rounded-xl">
                                <span class="text-amber-900 font-medium">Tamaño:</span>
                                <p class="text-gray-600">{pet.size}</p>
                            </div>
                            <div class="bg-amber-50 p-4 rounded-xl">
                                <span class="text-amber-900 font-medium">Especie:</span>
                                <p class="text-gray-600">{pet.species}</p>
                            </div>
                        </div>
                        <!-- Botones de acción y compartir -->
                        <div class="flex flex-col sm:flex-row gap-4 items-center">
                            <a
                                href={`/adopta/${pet.documentId}/adoptar`}
                                class="bg-amber-600 text-white text-center py-3 px-6 rounded-xl font-semibold hover:bg-amber-700 transition-colors flex items-center justify-center gap-2 flex-1"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5"
                                    viewBox="0 0 20 20"
                                    fill="currentColor"
                                >
                                    <path
                                        d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"
                                    ></path>
                                </svg>
                                Adoptar a {pet.name}
                            </a>
                            <a
                                href={`/adopta/${pet.documentId}/apadrinar`}
                                class="border-2 border-amber-600 text-amber-600 text-center py-3 px-6 rounded-xl font-semibold hover:bg-amber-50 transition-colors flex-1"
                            >
                                Apadrinar a {pet.name}
                            </a>
                            <div class="relative flex-1 flex justify-center sm:justify-end w-full">
                                <button id="share-btn" type="button" class="flex items-center gap-2 bg-amber-100 text-amber-700 px-4 py-2 rounded-lg shadow hover:bg-amber-200 transition-colors font-medium border border-amber-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6"cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                                    Compartir
                                </button>
                                <div id="share-menu" class="share-menu hidden absolute bottom-full mb-2 right-0 bg-white border border-gray-200 rounded-lg shadow-lg p-2 z-50 opacity-0 scale-95 transition-all min-w-[180px]">
                                    <span class="block text-gray-700 font-semibold mb-2 px-2">Compartir en:</span>
                                    <a href={`https://wa.me/?text=${encodeURIComponent(`${shareTitle} ${petUrl}`)}`} target="_blank" rel="noopener" class="block w-full text-left py-2 px-2 text-gray-800 hover:bg-amber-50 rounded">WhatsApp</a>
                                    <a href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(petUrl)}`} target="_blank" rel="noopener" class="block w-full text-left py-2 px-2 text-gray-800 hover:bg-amber-50 rounded">Facebook</a>
                                    <a href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareTitle)}&url=${encodeURIComponent(petUrl)}`} target="_blank" rel="noopener" class="block w-full text-left py-2 px-2 text-gray-800 hover:bg-amber-50 rounded">Twitter</a>
                                    <button id="copy-link-btn" class="block w-full text-left py-2 px-2 text-gray-800 hover:bg-amber-50 rounded">Copiar enlace</button>
                                </div>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mt-4 text-center sm:text-left">
                            Al enviar la solicitud estarás manifestando tu interés para que nuestro equipo te contacte y así evaluar juntos la adopción de {pet.name}.
                        </p>
                        <script define:vars={{ shareTitle, shareDescription, petUrl }}>
                            document.addEventListener("astro:page-load", () => {
                                const shareButton = document.getElementById("share-btn");
                                const shareMenu = document.getElementById("share-menu");
                                const copyLinkBtn = document.getElementById("copy-link-btn");
                                
                                if (!shareButton || !shareMenu || !copyLinkBtn) return;
                    
                                const shareData = {
                                    title: shareTitle,
                                    text: shareDescription,
                                    url: petUrl,
                                };
                    
                                const toggleShareMenu = () => {
                                    const isVisible = !shareMenu.classList.contains("hidden");
                                    if (isVisible) {
                                        shareMenu.classList.add("opacity-0", "scale-95");
                                        setTimeout(() => shareMenu.classList.add("hidden"), 200);
                                    } else {
                                        shareMenu.classList.remove("hidden");
                                        setTimeout(() => shareMenu.classList.remove("opacity-0", "scale-95"), 10);
                                    }
                                };
                                
                                shareButton.addEventListener("click", async (e) => {
                                    e.stopPropagation(); // Evita que el click cierre el menú inmediatamente
                                    if (navigator.share) {
                                        try {
                                            await navigator.share(shareData);
                                        } catch (err) {
                                            // El usuario cerró el diálogo de compartir, mostramos el menú como alternativa
                                            console.log("Web Share API falló o fue cancelada. Mostrando menú de fallback.");
                                            toggleShareMenu();
                                        }
                                    } else {
                                        // El navegador no soporta Web Share API
                                        toggleShareMenu();
                                    }
                                });
                    
                                copyLinkBtn.addEventListener("click", () => {
                                    navigator.clipboard.writeText(petUrl);
                                    copyLinkBtn.textContent = "¡Enlace copiado!";
                                    setTimeout(() => {
                                        copyLinkBtn.textContent = "Copiar enlace";
                                        toggleShareMenu(); // Opcional: cierra el menú después de copiar
                                    }, 1500);
                                });
                    
                                // Cierra el menú si se hace clic fuera de él
                                document.addEventListener("click", (e) => {
                                    if (!shareMenu.classList.contains("hidden") && !shareMenu.contains(e.target) && !shareButton.contains(e.target)) {
                                        toggleShareMenu();
                                    }
                                });
                            });
                        </script>
                    </div>
                </div>
            </div>

            <!-- Sección de más información -->
            <div class="bg-white rounded-2xl p-8 shadow-lg">
                <h2 class="text-2xl font-bold text-amber-900 mb-6">
                    ¿Por qué considerar la adopción de {pet.name}?
                </h2>
                <div class="grid md:grid-cols-3 gap-8">
                    <div class="flex flex-col items-center text-center p-4">
                        <div class="bg-amber-100 p-3 rounded-full mb-4">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-8 w-8 text-amber-600"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
                                ></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-amber-900 mb-2">
                            Amor incondicional
                        </h3>
                        <p class="text-gray-600">
                            Las mascotas ofrecen compañía y afecto sin
                            condiciones, mejorando tu bienestar emocional.
                        </p>
                    </div>
                    <div class="flex flex-col items-center text-center p-4">
                        <div class="bg-amber-100 p-3 rounded-full mb-4">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-8 w-8 text-amber-600"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                                ></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-amber-900 mb-2">
                            Salud mejorada
                        </h3>
                        <p class="text-gray-600">
                            Estudios demuestran que convivir con mascotas reduce
                            el estrés y mejora la salud cardiovascular.
                        </p>
                    </div>
                    <div class="flex flex-col items-center text-center p-4">
                        <div class="bg-amber-100 p-3 rounded-full mb-4">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-8 w-8 text-amber-600"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"
                                ></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-amber-900 mb-2">
                            Salvas una vida
                        </h3>
                        <p class="text-gray-600">
                            Al adoptar, no solo cambias tu vida sino que le das
                            una segunda oportunidad a un animal que lo necesita.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</Layout>
