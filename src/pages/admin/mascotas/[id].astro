---
import { actions } from "astro:actions";
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { CldImage, CldUploadWidget } from "astro-cloudinary";

export const prerender = false;

const { id } = Astro.params;

const { data, error } = await Astro.callAction(actions.getPet, { id });

if (error) {
    console.error(error);
    return Astro.redirect("/404");
}

if (data.pet[0].isAdopted) {
    return Astro.redirect("/mascotas");
}

const pet = data.pet[0] || {};

// Extraer el Public ID de Cloudinary de la URL si existe
function getPublicIdFromUrl(url) {
    if (!url) return null;

    // La URL generalmente es como: https://res.cloudinary.com/cloud-name/image/upload/v1234567890/folder/public_id.ext
    try {
        const urlObj = new URL(url);
        const pathParts = urlObj.pathname.split("/");
        // Eliminar 'image/upload' y la versión (v1234567890)
        const relevantPath = pathParts.slice(3).join("/");
        // Eliminar la extensión del archivo
        return relevantPath.replace(/\.[^/.]+$/, "");
    } catch (e) {
        return null;
    }
}

const petImagePublicId = pet?.imageUrl
    ? getPublicIdFromUrl(pet.imageUrl)
    : null;
---

<AdminLayout title="Editar mascota">
    <div class="max-w-2xl mx-auto p-6 bg-white rounded-lg shadow-md">
        <h1 class="text-2xl font-bold mb-6">
            {id ? "Editar" : "Crear nueva"} mascota
        </h1>

        <form method="POST" id="pet-form">
            {id && <input type="hidden" name="id" value={id} />}

            <div class="mb-4">
                <label for="name" class="block text-sm font-medium mb-1"
                    >Nombre:</label
                >
                <input
                    type="text"
                    id="name"
                    name="name"
                    value={pet?.name || ""}
                    class="w-full p-2 border rounded-md"
                    required
                />
            </div>

            <div class="mb-4">
                <label for="species" class="block text-sm font-medium mb-1"
                    >Especie:</label
                >
                <select
                    id="species"
                    name="species"
                    class="w-full p-2 border rounded-md"
                    required
                >
                    <option value="">Seleccionar especie</option>
                    <option value="perro" selected={pet?.species === "perro"}
                        >Perro</option
                    >
                    <option value="gato" selected={pet?.species === "gato"}
                        >Gato</option
                    >
                    <option value="otro" selected={pet?.species === "otro"}
                        >Otro</option
                    >
                </select>
            </div>

            <div class="mb-4">
                <label for="gender" class="block text-sm font-medium mb-1"
                    >Sexo:</label
                >
                <select
                    id="gender"
                    name="gender"
                    class="w-full p-2 border rounded-md"
                    required
                >
                    <option value="">Seleccionar sexo</option>
                    <option value="macho" selected={pet?.gender === "macho"}
                        >Macho</option
                    >
                    <option value="hembra" selected={pet?.gender === "hembra"}
                        >Hembra</option
                    >
                </select>
            </div>

            <div class="mb-4">
                <label for="description" class="block text-sm font-medium mb-1"
                    >Descripción:</label
                >
                <textarea
                    id="description"
                    name="description"
                    class="w-full p-2 border rounded-md h-32"
                    >{pet?.description || ""}</textarea
                >
            </div>

            <!-- Campo oculto para la URL de la imagen -->
            <input
                type="hidden"
                id="imageUrl"
                name="imageUrl"
                value={pet?.imageUrl || ""}
            />

            <!-- Sección de imagen -->
            <div class="mb-6">
                <label class="block text-sm font-medium mb-1">Imagen:</label>

                <!-- Previsualización de imagen existente usando CldImage -->
                <div id="image-preview" class="mb-3">
                    {
                        petImagePublicId ? (
                            <CldImage
                                src={petImagePublicId}
                                width="300"
                                height="300"
                                alt={`Imagen de ${pet?.name || "mascota"}`}
                            />
                        ) : (
                            <div class="bg-gray-100 w-64 h-64 flex items-center justify-center text-gray-400 rounded-md">
                                No hay imagen
                            </div>
                        )
                    }
                </div>

                <!-- Botón para subir imagen usando CldUploadWidget -->
                <CldUploadWidget
                    uploadPreset="pet uploads"
                    options={{
                        cloudName: "drxh1i9w6",
                        folder: "pets",
                        cropping: true,
                        multiple: false,
                        maxFileSize: 5000000,
                        showAdvancedOptions: false,
                    }}
                    onSuccess={(result) => {
                        if (result.info && result.info.secure_url) {
                            document.getElementById("imageUrl").value =
                                result.info.secure_url;
                            document.getElementById("image-preview").innerHTML =
                                `
                                <img 
                                    src="${result.info.secure_url}" 
                                    alt="Imagen de mascota" 
                                    class="max-w-xs h-auto rounded-md" 
                                />`;
                        }
                    }}
                >
                    <button
                        type="button"
                        class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600"
                    >
                        {pet?.imageUrl ? "Cambiar imagen" : "Subir imagen"}
                    </button>
                </CldUploadWidget>
            </div>

            <div class="flex gap-4">
                <button
                    type="submit"
                    class="bg-green-500 text-white px-6 py-2 rounded-md hover:bg-green-600"
                >
                    {id ? "Actualizar" : "Crear"} mascota
                </button>

                <a
                    href="/admin/pets"
                    class="bg-gray-300 text-gray-800 px-6 py-2 rounded-md hover:bg-gray-400"
                >
                    Cancelar
                </a>
            </div>
        </form>
    </div>
</AdminLayout>